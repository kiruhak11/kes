# Миграция на nuxt-file-storage

## Обзор изменений

Проект был мигрирован с локального хранения файлов на библиотеку `nuxt-file-storage` для обеспечения совместимости с продакшн окружением.

## Что изменилось

### 1. Конфигурация

В `nuxt.config.ts` добавлена конфигурация для `nuxt-file-storage`:

```typescript
fileStorage: {
  mount: process.env.FILE_STORAGE_MOUNT || './public/uploads'
}
```

### 2. API эндпоинты

Созданы API эндпоинты для работы с файлами:

- `POST /api/files` - загрузка файлов
- `DELETE /api/files` - удаление файлов  
- `GET /api/files` - получение списка файлов
- `GET /api/uploads/[fileName]` - раздача загруженных файлов

### 3. Новый composable

Создан `composables/useFileStorage.ts` для работы с файлами:

```typescript
const { uploadFiles, uploadSingleFile, deleteFile, getFiles } = useFileStorage()
```

### 4. Обновленные функции загрузки

В `pages/admin.vue` обновлены функции:
- `handleImageUpload` - теперь использует `uploadSingleFile`
- `handleGalleryUpload` - теперь использует `uploadFiles`
- `handleEditGalleryUpload` - теперь использует `uploadFiles`

## Настройка окружения

### Для разработки

Создайте файл `.env` в корне проекта:

```env
FILE_STORAGE_MOUNT=./public/uploads
```

### Для продакшена

Установите переменную окружения `FILE_STORAGE_MOUNT` с абсолютным путем к папке для хранения файлов.

## Структура файлов

Файлы сохраняются в структуре:
```
public/uploads/
├── [уникальный_id_1].[расширение]
├── [уникальный_id_2].[расширение]
└── ...
```

И доступны через API:
```
/api/uploads/[имя_файла]
```

## Docker конфигурация

### Docker Compose

Добавлен volume для сохранения файлов:
```yaml
volumes:
  - ./public/uploads:/app/public/uploads
```

### Переменные окружения

В docker-compose.yml добавлена переменная:
```yaml
environment:
  - FILE_STORAGE_MOUNT=/app/public/uploads
```

## Преимущества новой системы

1. **Уникальные имена файлов** - автоматическая генерация уникальных ID
2. **Безопасность** - проверка типов файлов и валидация путей
3. **Масштабируемость** - готовность к продакшн окружению
4. **Унифицированный API** - единый интерфейс для работы с файлами
5. **Простота** - использует встроенные возможности Nuxt

## Деплой на продакшен

### Автоматический деплой

Используйте команду:
```bash
npm run deploy
```

Эта команда:
1. Создает папку `public/uploads` на сервере
2. Останавливает контейнеры
3. Очищает Docker
4. Обновляет код
5. Пересобирает и запускает контейнеры

## Тестирование

Для тестирования новой системы:

1. Запустите сервер разработки: `npm run dev`
2. Откройте админ панель: `/admin`
3. Попробуйте загрузить изображения для товаров
4. Проверьте, что файлы сохраняются в `public/uploads/`
5. Убедитесь, что изображения отображаются по адресу `/api/uploads/[имя_файла]`

## Решение проблем

### Файлы не отображаются (404 ошибка)

Если файлы загружаются, но не отображаются:

1. Убедитесь, что папка `public/uploads/` существует
2. Проверьте права доступа к папке
3. Убедитесь, что файлы сохраняются в правильную папку
4. Проверьте, что пути в базе данных корректны (должны начинаться с `/api/uploads/`)

### Проверка volume в Docker

Проверьте, что volume правильно подключен:
```bash
docker exec -it kes-site-node ls -la /app/public/uploads
``` 